<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title></title>
	<script src="js/jquery2.0.0.js"></script>
	<script src="js/p5.js"></script>
	<script src="js/p5.dom.js"></script>
	<script src="js/p5.sound.js"></script>	
	<script src="js/socket.io.js"></script>
	<style>
	img{
		width: 120px;
		height: 70px;
		margin-right: 5px;
		margin-left: 5px;
		border: 2px solid gray;
	}	
	</style>
</head>
<html>
<body>
	<script type="text/javascript">
	var capture;
	var video2;
	var socket = io.connect('https://'+document.domain+":"+location.port);
	var personalId = null;
	var containsAllids = [];
	
	socket.on('myId', function(myId){
		personalId = myId;				
	});

	socket.on('remove-user', function(data){					
      $('#'+data.detail).remove();
      containsAllids.splice(containsAllids.indexOf(data.detail),1);
    });

	socket.on('connectIds', function(allIds){		
		containsAllids = allIds;		
		$('img').remove();
		$.each(allIds, function(index, value){
			if(value != personalId){				
				$('body').append('<img id='+value+'>');
			}			
		});		
	});

	socket.on('updateAllUser', function(data){			
		
		for(var i=0; i<containsAllids.length; i++){
			if(containsAllids[i] == data.streamId){
				$('#'+data.streamId).attr('src', data.capture);	
			}
		} 
		/*
		for(var i=0; i<containsAllids.length; i++){
			//var blob[i]
			if(containsAllids[i] == data.streamId){
				blob[i] = new Promise(function(resolve,reject){
					resolve(data);
				}); 
			}
			blob[i].then(function(result){
			$('#'+result.streamId).attr('src', result.capture);
		});
		}*/		
	});	
	
	function setup(){
	//capture = 						
		video2 = createCanvas(120,70);
		var constraints = {
	    	audio: false,
    		video: {
      			facingMode: "user"      			
    		},
    		width: 120,
        	height: 70    		
  		};
  		capture = createCapture(constraints)
  		capture.hide();
	}
	function draw(){
		image(capture, 0, 0, 120, 70);
		if(frameRate() > 60 && personalId != null && containsAllids.length > 0){
			socket.emit('updateUser', {streamId:personalId, capture:video2.canvas.toDataURL()});
		}
	}
	</script>	
</body>	
</html>
